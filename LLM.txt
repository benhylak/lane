# Lane - Git Worktree Alternative

## What is Lane?

A CLI tool that provides a simpler alternative to git worktrees. Lets you work on multiple branches simultaneously without stashing or context switching.

## Quick Start

```bash
# Build the project
bun run build

# Run the CLI
./lane                    # Interactive picker
./lane new feature-x      # Create new lane
./lane switch feature-x   # Switch to lane
./lane -                  # Go to previous lane
./lane main               # Back to main repo
```

## Build System

**Important:** This project uses **Bun runtime**, not Node.

```bash
# Build
bun run build

# Watch mode (development)
bun run dev

# Run tests
bun test

# Test watch mode
bun run test:watch
```

The build process uses `esbuild` via `bunx` with explicit JSX production runtime:
- `--jsx=automatic --jsx-import-source=react`
- Outputs `lane.mjs` (ES module bundle)
- Creates `lane` executable with shebang wrapper

## Architecture

```
src/
├── cli/                    # CLI layer (Commander.js)
│   ├── index.ts            # Main entry point
│   ├── utils.ts            # Shared utilities (renderUI, CD_PREFIX)
│   └── commands/           # Individual command modules (13 files)
│       ├── new.ts
│       ├── switch.ts
│       ├── list.ts
│       ├── remove.ts
│       ├── rename.ts
│       ├── checkout.ts
│       ├── sync.ts
│       ├── status.ts
│       ├── config.ts
│       ├── edit.ts
│       ├── init-shell.ts
│       └── default.ts
├── ui/                     # UI layer (Ink/React)
│   ├── LaneList.tsx        # Interactive lane picker
│   ├── Settings.tsx        # Settings configuration
│   ├── CheckoutSelector.tsx # Branch checkout UI
│   └── LaneManager.tsx     # Lane management UI
├── lanes.ts                # Core lane logic (1150 lines)
├── git.ts                  # Git operations wrapper (256 lines)
└── config.ts               # Config persistence (181 lines)
```

## Key Technologies

| Layer | Technology |
|-------|-----------|
| Runtime | **Bun** (not Node) |
| CLI Framework | Commander.js |
| UI Framework | Ink (React for terminal) |
| Build | esbuild via bunx |
| Tests | Bun's built-in test framework |
| Types | TypeScript with @types/bun |

## Bun-Specific APIs Used

**File operations:**
```typescript
const file = Bun.file(path);
const content = await file.text();
const exists = file.size > 0;
```

**Process spawning:**
```typescript
const proc = Bun.spawn(["git", "status", "--porcelain"], {
  cwd,
  stdout: "pipe",
  stderr: "pipe",
});
await proc.exited;
const output = await new Response(proc.stdout).text();
```

**Template literal syntax:**
```typescript
const output = await Bun.$`git rev-parse --show-toplevel`.cwd(cwd).quiet().text();
```

## Shell Integration

The CLI outputs a special prefix for shell integration:
```typescript
const CD_PREFIX = "__lane_cd:";
console.log(`${CD_PREFIX}${path}`);  // Shell function intercepts and cd's
```

## JSX Production Runtime

**Critical:** The build must use `--jsx=automatic --jsx-import-source=react` to avoid the dev runtime bug. Do NOT use `bun build` directly - it has a bug where it bundles `react/jsx-dev-runtime` regardless of config.

## Commands

| Command | Description |
|---------|-------------|
| `lane [name]` | Create or switch to lane (interactive if no args) |
| `lane -` | Go to previous lane |
| `lane new <name>` | Create new lane (full copy) |
| `lane switch <name>` | Switch to existing lane |
| `lane checkout <branch>` | Smart checkout (find or create lane) |
| `lane list` | List all lanes |
| `lane remove <name>` | Delete a lane |
| `lane rename <name>` | Rename current lane |
| `lane sync [name]` | Copy .env files from main to lane |
| `lane status` | Show current lane info |
| `lane config` | Interactive settings UI |
| `lane init-shell` | Set up shell integration |

## Lane Modes

1. **Worktree mode** (default): Uses `git worktree` - shares git object database
2. **Full copy mode**: Complete repository copy - isolated but slower

## Testing

```bash
# Run all tests
bun test

# Watch mode
bun test --watch

# Coverage
bun test --coverage
```

Test files:
- `test/lanes.test.ts` - Core lane operations (1400 lines)
- `test/git.test.ts` - Git operations (614 lines)
- `test/config.test.ts` - Config management (726 lines)

## Common Tasks

**Adding a new command:**
1. Create file in `src/cli/commands/`
2. Export `registerXxxCommand(program)` function
3. Import and call in `src/cli/index.ts`

**Modifying UI:**
- Edit components in `src/ui/`
- Use Ink primitives: `<Text>`, `<Box>`, `<Flex>`
- Import via `renderUI()` from `src/cli/utils.ts`

**Git operations:**
- Use functions from `src/git.ts`
- All use Bun.spawn for process execution

**Config changes:**
- Edit `src/config.ts`
- Uses Bun.file for I/O

## Gitignore Patterns

Build artifacts to ignore:
- `lane` - executable wrapper
- `lane.mjs` - bundled output
- `*.map` - source maps
- `*-bundle` - bundle files

## Branch

This work is on `bun-migration` branch - a complete migration from npm/Node to Bun runtime.
